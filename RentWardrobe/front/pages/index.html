<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8" />
    <title>RentWardrobe</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
            href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&display=swap"
            rel="stylesheet"
    />
    <!-- Font Awesome 6 (іконки) -->
    <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"
    />
    <!-- Підключення файлу зі стилями -->
    <link rel="stylesheet" href="/styles/index.css" />
</head>
<body>

<!-- Верхній рядок -->
<div class="top-message">
    <span>YOUR PERFECT PROM LOOK STARTS HERE</span>
    <span>YOUR PERFECT PROM LOOK STARTS HERE</span>
    <span>YOUR PERFECT PROM LOOK STARTS HERE</span>
</div>

<!-- Хедер -->
<header>
    <a href="index.html" style="color: inherit; text-decoration: none;">
        <div class="logo">RentWardrobe</div>
    </a>
    <nav class="menu">
        <ul>
            <!-- Приклади пунктів меню -->
            <li class="dropdown">
                <a href="#">Жіночий одяг <i class="fa fa-chevron-down"></i></a>
                <div class="mega-menu">
                    <ul>
                        <li><a href="#">Вечірні сукні</a></li>
                        <li><a href="#">Аксесуари</a></li>
                    </ul>
                </div>
            </li>
            <li class="dropdown">
                <a href="#">Чоловічий одяг <i class="fa fa-chevron-down"></i></a>
                <div class="mega-menu">
                    <ul>
                        <li><a href="#">Костюми</a></li>
                        <li><a href="#">Взуття</a></li>
                    </ul>
                </div>
            </li>
            <li class="search-container">
                <a href="#" id="toggleSearch">Пошук <i class="fa fa-search"></i></a>
                <input type="text" id="searchInput" placeholder="Введіть назву товару..." style="display: none;" />
            </li>
            <li><a href="#" id="profileLink">Особистий кабінет</a></li>
        </ul>
    </nav>
    <div class="right-actions">
        <a href="cart.html"><i class="fa-solid fa-cart-shopping"></i></a>
        <a href="#" id="profileLinkIcon"><i class="fa-solid fa-user"></i></a>
    </div>
</header>

<div class="container">
    <aside class="filters">
        <h3>Фільтр</h3>
        <div class="filter-group">
            <h4>Колір</h4>
            <ul>
                <li><a href="#">Чорний</a></li>
                <li><a href="#">Білий</a></li>
                <li><a href="#">Червоний</a></li>
            </ul>
        </div>
        <div class="filter-group">
            <h4>Розмір</h4>
            <ul>
                <li><a href="#">XS</a></li>
                <li><a href="#">S</a></li>
                <li><a href="#">M</a></li>
                <li><a href="#">L</a></li>
                <li><a href="#">XL</a></li>
            </ul>
        </div>
    </aside>

    <section class="content-area">
        <div class="breadcrumbs">
            <a href="#">RentWardrobe</a> / <a href="#">Усі Товари</a>
        </div>

        <div class="content-header">
            <h2>Товари</h2>
            <div class="sort-dropdown">
                <label for="sortSelect">Сортування:</label>
                <select id="sortSelect">
                    <option value="default">За замовчуванням</option>
                    <option value="price-asc">Від дешевих до дорогих</option>
                    <option value="price-desc">Від дорогих до дешевих</option>
                </select>
            </div>
        </div>

        <!-- Сітка товарів -->
        <div class="product-grid">
            <!-- Товари буде завантажено динамічно -->
        </div>
    </section>
</div>

<script>
    function attachDetailsHandlers() {
        const detailButtons = document.querySelectorAll('.details-btn');
        detailButtons.forEach((btn) => {
            btn.addEventListener('click', (e) => {
                const productCard = e.target.closest('.product-card');
                const productData = productCard.getAttribute('data-product');
                sessionStorage.setItem('selectedProduct', productData);
                window.location.href = 'product.html';
            });
        });
    }

    async function loadProducts() {
        try {
            const res = await fetch('/api/products');
            const products = await res.json();

            sessionStorage.setItem('allProducts', JSON.stringify(products));

            const grid = document.querySelector('.product-grid');
            grid.innerHTML = '';

            products.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.setAttribute('data-product', JSON.stringify(product));

                card.innerHTML = `
                    <i class="fa-regular fa-heart heart-icon"></i>
                    <img src="${product.img}" alt="${product.title}" />
                    <h3>${product.title}</h3>
                    <button class="details-btn">Детальніше</button>
                `;

                grid.appendChild(card);
            });

            attachDetailsHandlers();
            initHeartIcons();
        } catch (err) {
            console.error('Помилка при завантаженні товарів', err);
        }
    }

    function checkAuthentication() {
        return localStorage.getItem('isAuthenticated') === 'true';
    }

    function handleProfileClick(event) {
        event.preventDefault();
        window.location.href = 'userProfile.html';
    }

    document.getElementById('profileLink').addEventListener('click', handleProfileClick);
    document.getElementById('profileLinkIcon').addEventListener('click', handleProfileClick);

    // ❤️ Ініціалізація сердечок (додати/залити + заповнення)
    async function initHeartIcons() {
        const email = localStorage.getItem('currentUserEmail');
        const heartIcons = document.querySelectorAll('.heart-icon');

        let favorites = [];

        if (email) {
            try {
                const res = await fetch(`/api/user/${email}`);
                const user = await res.json();
                favorites = user.favorites || [];
            } catch (err) {
                console.error('Помилка при отриманні favorites', err);
            }
        }

        heartIcons.forEach(icon => {
            const productCard = icon.closest('.product-card');
            const productData = JSON.parse(productCard.getAttribute('data-product'));

            if (favorites.includes(productData.code)) {
                icon.classList.remove('fa-regular');
                icon.classList.add('fa-solid');
            }

            icon.addEventListener('click', async (e) => {
                e.stopPropagation();
                if (!email) {
                    alert('Будь ласка, увійдіть в акаунт, щоб додавати в обране.');
                    return;
                }

                if (icon.classList.contains('fa-regular')) {
                    // Додати до обраного
                    try {
                        const res = await fetch(`/api/user/${email}/favorites`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ productCode: productData.code })
                        });

                        if (res.ok) {
                            icon.classList.remove('fa-regular');
                            icon.classList.add('fa-solid');
                        }
                    } catch (err) {
                        console.error('Помилка при додаванні в обране', err);
                    }
                } else {
                    // Видалити з обраного
                    try {
                        const res = await fetch(`/api/user/${email}/favorites/${productData.code}`, {
                            method: 'DELETE'
                        });

                        if (res.ok) {
                            icon.classList.remove('fa-solid');
                            icon.classList.add('fa-regular');
                        }
                    } catch (err) {
                        console.error('Помилка при видаленні з обраного', err);
                    }
                }
            });
        });
    }

    document.getElementById('toggleSearch').addEventListener('click', function (e) {
        e.preventDefault();
        const input = document.getElementById('searchInput');
        input.style.display = input.style.display === 'none' ? 'inline-block' : 'none';
        input.focus();
    });

    document.getElementById('searchInput').addEventListener('input', function () {
        const query = this.value.toLowerCase();
        const allProducts = JSON.parse(sessionStorage.getItem('allProducts')) || [];
        const filtered = allProducts.filter(p => p.title.toLowerCase().includes(query));

        const grid = document.querySelector('.product-grid');
        grid.innerHTML = '';

        filtered.forEach(product => {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.setAttribute('data-product', JSON.stringify(product));
            card.innerHTML = `
                <i class="fa-regular fa-heart heart-icon"></i>
                <img src="${product.img}" alt="${product.title}" />
                <h3>${product.title}</h3>
                <button class="details-btn">Детальніше</button>
            `;
            grid.appendChild(card);
        });

        attachDetailsHandlers();
        initHeartIcons();
    });

    window.onload = loadProducts;
</script>

</body>
</html>
